// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id         String   @id @default(cuid())
  email      String   @unique
  name       String?
  password   String?  // Nullable for Google OAuth users
  phone      String?
  role       String   @default("USER")
  provider   String   @default("local") // "local" | "google"
  providerId String?  // Google sub ID for Google users
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]

  @@index([provider, providerId]) // Index for Google OAuth lookups
  @@map("users")
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String  @default("India")
  isDefault    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("addresses")
}

model Product {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  sku           String?       @unique
  description   String?       @db.Text
  price         Float
  originalPrice Float?
  image         String
  images        String[]      @default([])
  category      String // Legacy: kept for backward compatibility
  categoryId    String? // New: FK to Category
  categoryRef   Category?     @relation(fields: [categoryId], references: [id])
  status        ProductStatus @default(DRAFT)
  inStock       Boolean       @default(true)
  stockQuantity Int           @default(0)
  rating        Float?        @default(0)
  reviewCount   Int           @default(0)

  // SEO fields
  metaTitle       String?
  metaDescription String?  @db.Text
  metaKeywords    String[] @default([])
  ogImage         String?

  // Physical attributes
  weight     Float? // in grams
  dimensions Json? // { length, width, height, unit }
  taxClass   String? @default("standard")

  // Supplier information
  supplierName          String?
  supplierLocation      String?
  supplierCertification String?

  // Return policy
  returnPolicy String? @db.Text
  returnDays   Int?    @default(7)

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])

  cartItems      CartItem[]
  orderItems     OrderItem[]
  wishlistItems  WishlistItem[]
  reviews        Review[]
  stockMovements StockMovement[]
  variants       ProductVariant[]
  attributes     ProductAttribute[]
  tags           ProductTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([status])
  @@index([brandId])
  @@index([sku])
  @@map("products")
}

model CartItem {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String? // Optional: for variant-based products
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  quantity Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Order {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  addressId String
  address   Address @relation(fields: [addressId], references: [id])

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String
  paymentId     String?

  subtotal Float
  shipping Float @default(0)
  tax      Float @default(0)
  total    Float

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]
  payment    Payment?
  shipment   Shipment?

  @@map("orders")
}

model OrderItem {
  id        String          @id @default(cuid())
  orderId   String
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String? // Optional: for variant-based products
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  quantity Int
  price    Float

  createdAt DateTime @default(now())

  @@map("order_items")
}

model Review {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating   Int // 1-5
  comment  String? @db.Text
  verified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("reviews")
}

model Blog {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String    @db.Text
  content     String?   @db.Text
  image       String
  category    String
  author      String?
  readTime    String?
  tags        String[]  @default([])
  published   Boolean   @default(false)
  publishedAt DateTime?

  faqs BlogFAQ[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blogs")
}

model BlogFAQ {
  id     String @id @default(cuid())
  blogId String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)

  question String @db.Text
  answer   String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog_faqs")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

// Payment model for Razorpay integration
model Payment {
  id            String        @id @default(cuid())
  orderId       String        @unique
  order         Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Razorpay fields
  razorpayOrderId   String?  @unique // Razorpay order ID
  razorpayPaymentId String?  @unique // Razorpay payment ID
  razorpaySignature String?  // Webhook signature
  
  // Payment details
  gateway       String        // 'razorpay' | 'cod'
  amount        Float         // Amount in rupees (not paise)
  currency      String        @default("INR")
  status        PaymentStatus @default(PENDING)
  
  // Payment method details
  method        String?       // 'card', 'netbanking', 'wallet', 'upi', 'cod'
  bank          String?       // Bank name for netbanking
  wallet        String?       // Wallet name
  vpa           String?       // UPI VPA
  
  // Refund details
  refundId      String?       // Razorpay refund ID (deprecated - use Refund model)
  refundAmount  Float?        // Total refunded amount (sum of all refunds)
  refundStatus  String?       // 'pending', 'processed', 'failed'
  
  // Metadata
  metadata      Json?         // Additional payment data from Razorpay
  failureReason String?       @db.Text // Reason for failure
  
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt

  // Relations
  refunds       Refund[]
  auditLogs    PaymentAuditLog[]
  webhookEvents WebhookEvent[]

  @@index([orderId])
  @@index([razorpayOrderId])
  @@index([razorpayPaymentId])
  @@index([status])
  @@index([createdAt])
  @@map("payments")
}

// Webhook Event model for idempotency
model WebhookEvent {
  id              String   @id @default(cuid())
  razorpayEventId String   @unique // Razorpay's event ID (from webhook payload)
  eventType       String   // 'payment.captured', 'payment.failed', 'refund.processed', etc.
  paymentId       String?
  payment         Payment? @relation(fields: [paymentId], references: [id], onDelete: SetNull)
  orderId         String?
  processed       Boolean  @default(false)
  processedAt     DateTime?
  error           String?  @db.Text // Error message if processing failed
  payload         Json?    // Store full webhook payload for debugging
  createdAt       DateTime @default(now())

  @@index([razorpayEventId])
  @@index([processed])
  @@index([paymentId])
  @@index([orderId])
  @@index([createdAt])
  @@map("webhook_events")
}

// Refund model for tracking multiple refunds
model Refund {
  id                String   @id @default(cuid())
  paymentId         String
  payment           Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  razorpayRefundId  String   @unique // Razorpay refund ID
  amount            Float    // Refund amount in rupees
  currency          String   @default("INR")
  status            String   // 'pending', 'processed', 'failed'
  reason            String?  @db.Text
  notes             Json?    // Additional refund data
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  @@index([paymentId])
  @@index([razorpayRefundId])
  @@index([status])
  @@index([createdAt])
  @@map("refunds")
}

// Payment Audit Log for compliance and tracking
model PaymentAuditLog {
  id          String   @id @default(cuid())
  paymentId   String
  payment     Payment  @relation(fields: [paymentId], references: [id], onDelete: Cascade)
  action      String   // 'created', 'verified', 'captured', 'failed', 'refunded', 'status_changed'
  performedBy String?  // User ID or 'system' or 'razorpay_webhook'
  oldStatus   String?
  newStatus   String
  metadata    Json?    // Additional context
  createdAt   DateTime @default(now())

  @@index([paymentId])
  @@index([action])
  @@index([createdAt])
  @@index([performedBy])
  @@map("payment_audit_logs")
}

// Failed Webhook model for retry mechanism
model FailedWebhook {
  id        String   @id @default(cuid())
  payload   Json     // Full webhook payload
  signature String   // Webhook signature
  eventId   String?  // Razorpay event ID if available
  error     String   @db.Text // Error message
  retries   Int      @default(0)
  lastRetryAt DateTime?
  maxRetries Int     @default(5)
  processed Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([retries])
  @@index([processed])
  @@index([createdAt])
  @@map("failed_webhooks")
}

// Shipment model for Shiprocket integration
model Shipment {
  id        String   @id @default(cuid())
  orderId   String   @unique
  order     Order    @relation(fields: [orderId], references: [id], onDelete: Cascade)
  
  // Shiprocket fields
  shiprocketOrderId     String?  @unique // Shiprocket order ID
  shiprocketShipmentId  String?  @unique // Shiprocket shipment ID
  awbNumber             String?  @unique // Airway Bill Number
  
  // Courier details
  courierName            String?
  courierId              String?
  courierTrackingUrl     String?
  
  // Shipment details
  status                 ShipmentStatus @default(PENDING)
  trackingUrl            String?
  labelUrl               String? // Shipping label URL
  manifestUrl            String? // Manifest URL
  
  // Address details (stored for reference)
  pickupAddress          Json? // Pickup address
  deliveryAddress        Json? // Delivery address
  
  // Weight and dimensions
  weight                 Float? // in grams
  length                 Float? // in cm
  breadth                Float? // in cm
  height                 Float? // in cm
  
  // Shipping charges
  shippingCharges        Float?
  codCharges             Float?
  totalCharges           Float?
  
  // Status updates
  currentStatus          String? // Current shipment status from Shiprocket
  statusHistory          Json? // Array of status updates
  
  // RTO (Return to Origin) details
  rtoStatus              String? // RTO status if applicable
  rtoAwbNumber           String?
  
  // Metadata
  metadata               Json? // Additional Shiprocket data
  
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt
  
  @@index([orderId])
  @@index([shiprocketOrderId])
  @@index([shiprocketShipmentId])
  @@index([awbNumber])
  @@index([status])
  @@map("shipments")
}

enum ShipmentStatus {
  PENDING           // Shipment not created yet
  PROCESSING        // Shipment being processed
  READY_TO_SHIP     // Ready for pickup
  PICKED_UP         // Picked up by courier
  IN_TRANSIT        // In transit
  OUT_FOR_DELIVERY  // Out for delivery
  DELIVERED         // Delivered
  FAILED            // Delivery failed
  RTO               // Return to Origin
  CANCELLED         // Cancelled
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model StockMovement {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String? // Optional: for variant-based stock tracking
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: Cascade)

  type          StockMovementType
  quantity      Int // Positive for additions, negative for deductions
  previousStock Int // Stock quantity before this movement
  newStock      Int // Stock quantity after this movement
  reason        String?           @db.Text
  referenceId   String? // Reference to order, adjustment, etc.
  referenceType String? // 'ORDER', 'ADJUSTMENT', 'RETURN', etc.

  createdBy String? // User ID who made the change
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([variantId])
  @@index([createdAt])
  @@index([type])
  @@map("stock_movements")
}

enum StockMovementType {
  IN // Stock added
  OUT // Stock removed (sale, damage, etc.)
  ADJUSTMENT // Manual adjustment
  RETURN // Return from customer
  TRANSFER // Transfer between locations (future use)
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  type        String   @default("string") // 'string', 'number', 'boolean', 'json'
  group       String // 'general', 'product', 'shipping', 'payment', 'email', 'seo', 'tax'
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("settings")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryParent")
  order       Int        @default(0) // For sorting
  isActive    Boolean    @default(true)
  // Navigation settings
  showInNav   Boolean    @default(false) // Whether to show this category in the main navigation
  navOrder    Int        @default(0) // Order within navigation
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products Product[] // New: products with FK relationship

  @@map("categories")
}

// Brand model
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  logo        String?
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("brands")
}

// Product Variant model
model ProductVariant {
  id            String  @id @default(cuid())
  productId     String
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku           String  @unique
  name          String // e.g., "Gold - Size 7"
  price         Float? // Optional override from product price
  stockQuantity Int     @default(0)
  attributes    Json // { size: "7", color: "gold", material: "14k" }
  image         String? // Variant-specific image

  cartItems      CartItem[]
  orderItems     OrderItem[]
  stockMovements StockMovement[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// Product Attribute model (for specifications)
model ProductAttribute {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  key       String // e.g., "material", "weight", "dimensions"
  value     String // e.g., "14k Gold", "5g", "2x2cm"

  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_attributes")
}

// Product Tag model
model ProductTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("product_tags")
}
