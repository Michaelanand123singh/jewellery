// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model User {
  id        String   @id @default(cuid())
  email     String   @unique
  name      String?
  password  String
  phone     String?
  role      String   @default("USER")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  addresses     Address[]
  orders        Order[]
  cartItems     CartItem[]
  wishlistItems WishlistItem[]
  reviews       Review[]

  @@map("users")
}

model Address {
  id     String @id @default(cuid())
  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  fullName     String
  phone        String
  addressLine1 String
  addressLine2 String?
  city         String
  state        String
  postalCode   String
  country      String  @default("India")
  isDefault    Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orders Order[]

  @@map("addresses")
}

model Product {
  id            String        @id @default(cuid())
  name          String
  slug          String        @unique
  sku           String?       @unique
  description   String?       @db.Text
  price         Float
  originalPrice Float?
  image         String
  images        String[]      @default([])
  category      String // Legacy: kept for backward compatibility
  categoryId    String? // New: FK to Category
  categoryRef   Category?     @relation(fields: [categoryId], references: [id])
  status        ProductStatus @default(DRAFT)
  inStock       Boolean       @default(true)
  stockQuantity Int           @default(0)
  rating        Float?        @default(0)
  reviewCount   Int           @default(0)

  // SEO fields
  metaTitle       String?
  metaDescription String?  @db.Text
  metaKeywords    String[] @default([])
  ogImage         String?

  // Physical attributes
  weight     Float? // in grams
  dimensions Json? // { length, width, height, unit }
  taxClass   String? @default("standard")

  // Supplier information
  supplierName          String?
  supplierLocation      String?
  supplierCertification String?

  // Return policy
  returnPolicy String? @db.Text
  returnDays   Int?    @default(7)

  // Relations
  brandId String?
  brand   Brand?  @relation(fields: [brandId], references: [id])

  cartItems      CartItem[]
  orderItems     OrderItem[]
  wishlistItems  WishlistItem[]
  reviews        Review[]
  stockMovements StockMovement[]
  variants       ProductVariant[]
  attributes     ProductAttribute[]
  tags           ProductTag[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([categoryId])
  @@index([status])
  @@index([brandId])
  @@index([sku])
  @@map("products")
}

model CartItem {
  id        String          @id @default(cuid())
  userId    String
  user      User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id], onDelete: Cascade)
  variantId String? // Optional: for variant-based products
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  quantity Int @default(1)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId, variantId])
  @@map("cart_items")
}

model WishlistItem {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([userId, productId])
  @@map("wishlist_items")
}

model Order {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  addressId String
  address   Address @relation(fields: [addressId], references: [id])

  status        OrderStatus   @default(PENDING)
  paymentStatus PaymentStatus @default(PENDING)
  paymentMethod String
  paymentId     String?

  subtotal Float
  shipping Float @default(0)
  tax      Float @default(0)
  total    Float

  notes String? @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  orderItems OrderItem[]

  @@map("orders")
}

model OrderItem {
  id        String          @id @default(cuid())
  orderId   String
  order     Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId String
  product   Product         @relation(fields: [productId], references: [id])
  variantId String? // Optional: for variant-based products
  variant   ProductVariant? @relation(fields: [variantId], references: [id], onDelete: SetNull)

  quantity Int
  price    Float

  createdAt DateTime @default(now())

  @@map("order_items")
}

model Review {
  id        String  @id @default(cuid())
  userId    String
  user      User    @relation(fields: [userId], references: [id], onDelete: Cascade)
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  rating   Int // 1-5
  comment  String? @db.Text
  verified Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, productId])
  @@map("reviews")
}

model Blog {
  id          String    @id @default(cuid())
  title       String
  slug        String    @unique
  excerpt     String    @db.Text
  content     String?   @db.Text
  image       String
  category    String
  author      String?
  readTime    String?
  tags        String[]  @default([])
  published   Boolean   @default(false)
  publishedAt DateTime?

  faqs BlogFAQ[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blogs")
}

model BlogFAQ {
  id     String @id @default(cuid())
  blogId String
  blog   Blog   @relation(fields: [blogId], references: [id], onDelete: Cascade)

  question String @db.Text
  answer   String @db.Text

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("blog_faqs")
}

enum OrderStatus {
  PENDING
  CONFIRMED
  PROCESSING
  SHIPPED
  DELIVERED
  CANCELLED
  RETURNED
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum ProductStatus {
  DRAFT
  PUBLISHED
  ARCHIVED
}

model StockMovement {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)

  type          StockMovementType
  quantity      Int // Positive for additions, negative for deductions
  previousStock Int // Stock quantity before this movement
  newStock      Int // Stock quantity after this movement
  reason        String?           @db.Text
  referenceId   String? // Reference to order, adjustment, etc.
  referenceType String? // 'ORDER', 'ADJUSTMENT', 'RETURN', etc.

  createdBy String? // User ID who made the change
  createdAt DateTime @default(now())

  @@index([productId])
  @@index([createdAt])
  @@index([type])
  @@map("stock_movements")
}

enum StockMovementType {
  IN // Stock added
  OUT // Stock removed (sale, damage, etc.)
  ADJUSTMENT // Manual adjustment
  RETURN // Return from customer
  TRANSFER // Transfer between locations (future use)
}

model Setting {
  id          String   @id @default(cuid())
  key         String   @unique
  value       String   @db.Text
  type        String   @default("string") // 'string', 'number', 'boolean', 'json'
  group       String // 'general', 'product', 'shipping', 'payment', 'email', 'seo', 'tax'
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("settings")
}

model Category {
  id          String     @id @default(cuid())
  name        String
  slug        String     @unique
  description String?    @db.Text
  image       String?
  parentId    String?
  parent      Category?  @relation("CategoryParent", fields: [parentId], references: [id], onDelete: Cascade)
  children    Category[] @relation("CategoryParent")
  order       Int        @default(0) // For sorting
  isActive    Boolean    @default(true)
  // Navigation settings
  showInNav   Boolean    @default(false) // Whether to show this category in the main navigation
  navOrder    Int        @default(0) // Order within navigation
  createdAt   DateTime   @default(now())
  updatedAt   DateTime   @updatedAt

  products Product[] // New: products with FK relationship

  @@map("categories")
}

// Brand model
model Brand {
  id          String   @id @default(cuid())
  name        String   @unique
  slug        String   @unique
  logo        String?
  description String?  @db.Text
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  products Product[]

  @@map("brands")
}

// Product Variant model
model ProductVariant {
  id            String  @id @default(cuid())
  productId     String
  product       Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  sku           String  @unique
  name          String // e.g., "Gold - Size 7"
  price         Float? // Optional override from product price
  stockQuantity Int     @default(0)
  attributes    Json // { size: "7", color: "gold", material: "14k" }
  image         String? // Variant-specific image

  cartItems  CartItem[]
  orderItems OrderItem[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([productId])
  @@index([sku])
  @@map("product_variants")
}

// Product Attribute model (for specifications)
model ProductAttribute {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id], onDelete: Cascade)
  key       String // e.g., "material", "weight", "dimensions"
  value     String // e.g., "14k Gold", "5g", "2x2cm"

  createdAt DateTime @default(now())

  @@index([productId])
  @@map("product_attributes")
}

// Product Tag model
model ProductTag {
  id        String   @id @default(cuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  products Product[]

  @@map("product_tags")
}
